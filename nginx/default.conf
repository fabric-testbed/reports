# =========================
# Frontend (443) - Vouch + Reports API + MCP endpoints
# =========================
server {
    listen 443 ssl http2;
    # Use your real hostname or "_" for catch-all
    server_name $host;

    # --- allow larger request headers/cookies ---
    client_header_buffer_size 16k;
    large_client_header_buffers 8 64k;
    # -------------------------------------------

    root /var/www/html/;

    # TLS
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_certificate     /etc/ssl/public.pem;
    ssl_certificate_key /etc/ssl/private.pem;
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Size/time limits
    client_max_body_size 64m;
    proxy_read_timeout   1800s;
    proxy_send_timeout   1800s;
    proxy_connect_timeout 180s;
    send_timeout         1800s;

    # Forwarded headers for all proxied requests
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  $server_port;

    # ---------- Vouch validate endpoint (internal) ----------
    location = /validate {
        internal;
        proxy_pass http://vouch-proxy:9090/validate;

        # Vouch only needs headers, not body
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";

        # Expose Vouch headers to auth_request caller
        auth_request_set $auth_resp_x_vouch_user            $upstream_http_x_vouch_user;
        auth_request_set $auth_resp_x_vouch_idp_idtoken     $upstream_http_x_vouch_idp_idtoken;
        auth_request_set $auth_resp_x_vouch_idp_accesstoken $upstream_http_x_vouch_idp_accesstoken;
        auth_request_set $auth_resp_x_vouch_idp_refreshtoken $upstream_http_x_vouch_idp_refreshtoken;

        auth_request_set $auth_resp_jwt       $upstream_http_x_vouch_jwt;
        auth_request_set $auth_resp_err       $upstream_http_x_vouch_err;
        auth_request_set $auth_resp_failcount $upstream_http_x_vouch_failcount;
    }

    error_page 401 = @error401;
    location @error401 {
        return 302 $scheme://$host/login?url=$scheme://$host$request_uri&vouch-failcount=$auth_resp_failcount&X-Vouch-Token=$auth_resp_jwt&error=$auth_resp_err;
    }

    # Vouch routes (login/logout/ui)
    location /auth {
        proxy_pass http://vouch-proxy:9090;
    }
    location /login {
        proxy_pass http://vouch-proxy:9090/login?url=$scheme://$host;
    }
    location /logout {
        proxy_pass http://vouch-proxy:9090/logout?url=$scheme://$host;
    }

    # POST /ai (tool calls)
    location = /ai {
        proxy_pass http://reports-mcp-server:5000;
        proxy_pass_request_body on;
        proxy_set_header Content-Length $content_length;
        proxy_set_header Content-Type   $http_content_type;

        add_header Access-Control-Allow-Origin "https://n8n.pegasusai.io" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Authorization" always;
    }

    # ---------- Reports API (protected by Vouch) ----------
    location /reports {
        # Preflight
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Range, Authorization" always;
            add_header Access-Control-Max-Age 1728000 always;
            add_header Content-Type "text/plain; charset=utf-8" always;
            add_header Content-Length 0 always;
            return 204;
        }

        # Require login
        auth_request /validate;

        # Pass identity downstream if you want it
        proxy_set_header X-Vouch-User             $auth_resp_x_vouch_user;
        proxy_set_header X-Vouch-IdP-IdToken      $auth_resp_x_vouch_idp_idtoken;
        proxy_set_header X-Vouch-IdP-AccessToken  $auth_resp_x_vouch_idp_accesstoken;
        proxy_set_header X-Vouch-IdP-RefreshToken $auth_resp_x_vouch_idp_refreshtoken;

        proxy_pass http://reports-api:8080/reports;
    }
}

# =========================
# Grafana (8443) on /grafana/
# =========================
server {
    listen 8443 ssl http2;
    server_name _;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_certificate     /etc/ssl/public.pem;
    ssl_certificate_key /etc/ssl/private.pem;

    # If you later protect Grafana with Vouch, add auth_request like the Reports block.

    # Grafana (HTTP)
    location /grafana/ {
        # strip the prefix
        rewrite ^/grafana/(.*) /$1 break;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://reports-grafana:3000/;
    }

    # Grafana Live WebSockets
    location /grafana/api/live {
        rewrite ^/grafana/(.*) /$1 break;
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://reports-grafana:3000/;
    }
}
