services:
  database:
    image: fabrictestbed/postgres:12.3
    container_name: reports-db
    networks:
      - backend
    restart: always
    volumes:
      - ./pg_data/data:${PGDATA:-/var/lib/postgresql/data}
      - ./pg_data/logs:${POSTGRES_INITDB_WALDIR:-/var/log/postgresql}
    environment:
       - POSTGRES_HOST=${POSTGRES_HOST:-database}
       - POSTGRES_PORT=5432
       - POSTGRES_MULTIPLE_DATABASES=${POSTGRES_DB:-analytics}
       - POSTGRES_USER=${POSTGRES_USER:-fabric}
       - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-fabric}
       - PGDATA=${PGDATA:-/var/lib/postgresql/data}

  reports-api:
    build:
      context: reports_api/
      dockerfile: Dockerfile
    container_name: reports-api
    image: reports-api:latest
    restart: always
    depends_on:
      - database
    networks:
      - backend   # Ensure the API is on the backend network
    environment:
      DATABASE_URL: "postgresql://fabric:fabric@reports-db:5432/analytics"
    volumes:
      - ./reports_api/config.yml:/usr/src/app/config.yml
      - ./reports-logs:/var/log/reports

  mcp-server:
    build:
      # Set the build context to the subdirectory containing the Dockerfile and code
      context: mcp_server/
      dockerfile: Dockerfile
    container_name: reports-mcp-server
    image: reports-mcp-server:latest
    restart: always
    # The MCP server uses port 5000 internally (as defined in mcp_reports_server.py)
    networks:
      - backend
    # NOTE: We don't need 'ports:' here unless you want to access it directly from the host.
    # We rely on 'nginx' to route traffic to it.
    environment:
      MCP_TRANSPORT: "http"
      # If your client requires this for its base URL, define it here.
      # The MCP server uses this for the /capabilities response details.
      #REPORTS_API_BASE_URL: "https://reports.fabric-testbed.net/reports"
      REPORTS_API_BASE_URL: http://reports-api:8080/reports
    volumes:
      - ./mcp-logs:/var/log/mcp # Optional: for application logs

  nginx:
    image: library/nginx:1
    container_name: reports-nginx
    networks:
      - frontend
      - backend
    ports:
      - 8443:443
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./ssl/fullchain.pem:/etc/ssl/public.pem
      - ./ssl/privkey.pem:/etc/ssl/private.pem
      - ./nginx-logs:/var/log/nginx
    restart: always

networks:
  frontend:
  backend:
    internal: true
